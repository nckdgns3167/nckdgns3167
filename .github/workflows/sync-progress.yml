name: Sync Side Project Progress

# ì£¼ 1íšŒ ìë™ ê°±ì‹  (ë°±ì—…) + ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
on:
  schedule:
    # ë§¤ì£¼ ì¼ìš”ì¼ 21:00 KST (12:00 UTC)
    - cron: '0 12 * * 0'
  workflow_dispatch: # ìˆ˜ë™ íŠ¸ë¦¬ê±° (í…ŒìŠ¤íŠ¸ìš©)

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Query chartsage issues and calculate progress
        env:
          GH_TOKEN: ${{ secrets.CHARTSAGE_PAT }}
        run: |
          # chartsage private repoì—ì„œ ì´ìŠˆ ì¡°íšŒ
          TOTAL=$(gh issue list --repo nckdgns3167/chartsage --state all --limit 500 --json number -q 'length' || echo "0")
          CLOSED=$(gh issue list --repo nckdgns3167/chartsage --state closed --limit 500 --json number -q 'length' || echo "0")

          if [ "$TOTAL" -eq 0 ]; then
            echo "ì´ìŠˆ ì—†ìŒ, ìŠ¤í‚µ"
            echo "SKIP=true" >> $GITHUB_ENV
            exit 0
          fi

          PERCENTAGE=$(( (CLOSED * 100 + TOTAL / 2) / TOTAL ))
          [ "$PERCENTAGE" -gt 100 ] && PERCENTAGE=100

          echo "ì „ì²´: $TOTAL, ì™„ë£Œ: $CLOSED, ì§„í–‰ë¥ : ${PERCENTAGE}%"

          # í™œì„± Phase ê²°ì • (ê°€ì¥ ë‚®ì€ open phase)
          ACTIVE_PHASE=""
          for p in 1 2 3 4 5 6; do
            OPEN_COUNT=$(gh issue list --repo nckdgns3167/chartsage --state open --label "phase:${p}" --json number -q 'length' || echo "0")
            if [ "$OPEN_COUNT" -gt 0 ]; then
              ACTIVE_PHASE=$p
              break
            fi
          done

          # Phase â†’ Stage ë§¤í•‘
          case ${ACTIVE_PHASE:-0} in
            1|2|3|4) STAGE="ê°œë°œ" ;;
            5) STAGE="í…ŒìŠ¤íŠ¸" ;;
            6) STAGE="ë°°í¬" ;;
            0) [ "$PERCENTAGE" -ge 100 ] && STAGE="ë°°í¬" || STAGE="ê°œë°œ" ;;
          esac

          # ìµœê·¼ ë‹«íŒ ì´ìŠˆ ì œëª©ìœ¼ë¡œ ë©”ëª¨ ìƒì„±
          LAST_TITLE=$(gh issue list --repo nckdgns3167/chartsage --state closed --limit 1 --json title -q '.[0].title' || echo "")
          if [ -n "$LAST_TITLE" ]; then
            MEMO="${LAST_TITLE} ì™„ë£Œ"
          else
            MEMO="ê°œë°œ ì§„í–‰ ì¤‘"
          fi

          echo "PERCENTAGE=${PERCENTAGE}" >> $GITHUB_ENV
          echo "STAGE=${STAGE}" >> $GITHUB_ENV
          echo "MEMO=${MEMO}" >> $GITHUB_ENV
          echo "SKIP=false" >> $GITHUB_ENV

      - name: Update README.md
        if: env.SKIP != 'true'
        run: |
          python3 << 'PYEOF'
          import os

          percentage = int(os.environ['PERCENTAGE'])
          stage = os.environ['STAGE']
          memo = os.environ['MEMO']

          # í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìƒì„±
          filled = min(max((percentage + 5) // 10, 0), 10)
          empty = 10 - filled
          bar_line = '> ' + 'â–“' * filled + 'â–‘' * empty + f' **{percentage}%**'

          # ë‹¨ê³„ ë¼ì¸ ìƒì„± (ì™„ë£Œ: âœ…, í˜„ì¬: ğŸ”¨ **ë³¼ë“œ**, ë¯¸ì§„í–‰: ì¼ë°˜)
          stages = ['ê¸°íš', 'ì„¤ê³„', 'ê°œë°œ', 'í…ŒìŠ¤íŠ¸', 'ë°°í¬']
          parts = []
          found_current = False
          for s in stages:
              if s == stage:
                  parts.append(f'ğŸ”¨ **{s}**')
                  found_current = True
              elif not found_current:
                  parts.append(f'âœ… {s}')
              else:
                  parts.append(s)
          stage_line = '> ' + ' â†’ '.join(parts)

          # ë©”ëª¨ ë¼ì¸
          memo_line = f'> ğŸ“Œ ìµœê·¼ ì‘ì—…: {memo}'

          # README ë¼ì¸ ë‹¨ìœ„ êµì²´
          with open('README.md', 'r', encoding='utf-8') as f:
              lines = f.readlines()

          new_lines = []
          for line in lines:
              stripped = line.rstrip('\n')
              if 'â–“' in stripped or 'â–‘' in stripped:
                  new_lines.append(bar_line + '\n')
              elif 'ê¸°íš' in stripped and 'ë°°í¬' in stripped and 'â†’' in stripped:
                  new_lines.append(stage_line + '\n')
              elif 'ğŸ“Œ' in stripped:
                  new_lines.append(memo_line + '\n')
              else:
                  new_lines.append(line)

          with open('README.md', 'w', encoding='utf-8') as f:
              f.writelines(new_lines)

          print(f'âœ… ê°±ì‹  ì™„ë£Œ: {bar_line}')
          print(f'   ë‹¨ê³„: {stage_line}')
          print(f'   ë©”ëª¨: {memo_line}')
          PYEOF

      - name: Commit and push if changed
        if: env.SKIP != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git diff --quiet README.md && echo "ë³€ê²½ ì—†ìŒ, ì»¤ë°‹ ìƒëµ" && exit 0
          git add README.md
          git commit -m "ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ ì§„í–‰ë¥  ê°±ì‹ : ${PERCENTAGE}% ${STAGE} (ìë™)"
          git push
